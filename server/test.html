<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Disable pinch zoom by setting maximum-scale to 1.0 and user-scalable to no -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Parameters</title>
    <style>
      /* Disable scrolling and text selection on the entire document */
      html,
      body {
        overflow: hidden;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }
      body {
        font-family: Arial, sans-serif;
        padding: 10px; /* Reduced overall padding */
        touch-action: none; /* Prevent default pinch-zoom on the webpage */
      }
      /* Header container for the back button, title, and reset button */
      .header {
        position: relative;
        text-align: center;
        margin-bottom: 10px;
      }
      /* Small back button positioned at the left of the header */
      .back-button {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px; /* Small text */
        padding: 4px 8px; /* Small padding */
        border-radius: 5px;
        background-color: #eeeeee;
        color: #007bff;
        border: none;
        cursor: pointer;
      }
     .back-button:hover {
         background-color: #e0e0e0; /* Slightly darker on hover */
     }
     /* Reset button styled similarly to the back button, positioned at the right */
     .reset-button {
         position: absolute;
         right: 0;
         top: 50%;
         transform: translateY(-50%);
         font-size: 12px; /* Small text */
         padding: 4px 8px; /* Small padding */
         border-radius: 5px;
         background-color: #eeeeee;
         color: #007bff;
         border: none;
         cursor: pointer;
     }
     .reset-button:hover {
         background-color: #e0e0e0; /* Slightly darker on hover */
     }
     h2 {
         font-size: 16px; /* Smaller heading text */
         margin: 0; /* Remove default margin */
     }
      .slider-container {
        margin: 10px 0; /* Smaller margin between sliders */
        width: 100%;
      }
      .slider-container label {
        display: block;
        font-size: 14px; /* Smaller label text */
        margin-bottom: 3px; /* Reduced bottom margin for labels */
      }
      .slider {
        width: 100%;
        height: 8px;
        background: #ddd;
        border-radius: 4px;
        outline: none;
        transition: 0.2s;
      }
      input[type="submit"] {
        display: block;
        width: 100%;
        padding: 8px; /* Reduced padding */
        font-size: 14px; /* Smaller button text */
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 10px; /* Smaller top margin */
      }
     input[type="submit"]:hover {
         background-color: #0056b3;
     }
      #status {
        font-size: 12px; /* Smaller status text */
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <button type="button" class="back-button" onclick="window.location.href='/'">Back</button>
      <h2>Autocam Parameters</h2>
      <button type="button" class="reset-button" onclick="resetSliders()">Reset</button>
    </div>
    <form id="parameters-form">
      <div class="slider-container">
        <label>Delta: <span id="delta-value">0.5</span></label>
        <input class="slider" type="range" name="delta" min="0" max="2" step="0.01" value="0.5" oninput="updateValue('delta', this.value)" />
      </div>
      <div class="slider-container">
        <label>Kp_t: <span id="Kp_t-value">100</span></label>
        <input class="slider" type="range" name="Kp_t" min="0" max="200" step="0.1" value="100" oninput="updateValue('Kp_t', this.value)" />
      </div>
      <div class="slider-container">
        <label>Ki_t: <span id="Ki_t-value">0</span></label>
        <input class="slider" type="range" name="Ki_t" min="0" max="10" step="0.1" value="0" oninput="updateValue('Ki_t', this.value)" />
      </div>
      <div class="slider-container">
        <label>Kd_t: <span id="Kd_t-value">0</span></label>
        <input class="slider" type="range" name="Kd_t" min="0" max="10" step="0.1" value="0" oninput="updateValue('Kd_t', this.value)" />
      </div>
      <div class="slider-container">
        <label>Kp_s: <span id="Kp_s-value">10</span></label>
        <input class="slider" type="range" name="Kp_s" min="0" max="20" step="0.1" value="10" oninput="updateValue('Kp_s', this.value)" />
      </div>
      <div class="slider-container">
        <label>Ki_s: <span id="Ki_s-value">0</span></label>
        <input class="slider" type="range" name="Ki_s" min="0" max="10" step="0.1" value="0" oninput="updateValue('Ki_s', this.value)" />
      </div>
      <div class="slider-container">
        <label>Kd_s: <span id="Kd_s-value">0</span></label>
        <input class="slider" type="range" name="Kd_s" min="0" max="10" step="0.1" value="0" oninput="updateValue('Kd_s', this.value)" />
      </div>
      <div class="slider-container">
        <label>Max Throttle: <span id="maxMoveThrottle-value">300</span></label>
        <input class="slider" type="range" name="maxMoveThrottle" min="0" max="500" step="1" value="300" oninput="updateValue('maxMoveThrottle', this.value)" />
      </div>
      <div class="slider-container">
        <label>Min Throttle: <span id="minMoveThrottle-value">-300</span></label>
        <input class="slider" type="range" name="minMoveThrottle" min="0" max="500" step="1" value="300" oninput="updateValue('minMoveThrottle', this.value)" />
      </div>
      <div class="slider-container">
        <label>Max Steering: <span id="maxMoveSteering-value">500</span></label>
        <input class="slider" type="range" name="maxMoveSteering" min="0" max="500" step="1" value="500" oninput="updateValue('maxMoveSteering', this.value)" />
      </div>
      <div class="slider-container">
        <label>Min Steering: <span id="minMoveSteering-value">-500</span></label>
        <input class="slider" type="range" name="minMoveSteering" min="0" max="500" step="1" value="500" oninput="updateValue('minMoveSteering', this.value)" />
      </div>
      <input type="submit" value="Update" />
    </form>
    <p id="status"></p>
    <script>
     // Update the display. For the two "min" sliders, show the negative.
     function updateValue(id, value) {
         let displayValue = value;
         if (id === "minMoveThrottle" || id === "minMoveSteering") {
             displayValue = -value;
         }
         document.getElementById(id + "-value").textContent = displayValue;
         // Clear any successful message when a slider is changed.
         document.getElementById("status").textContent = "";
     }
     // Reset all sliders to their current values as in the form.
     function resetSliders() {
         // Reset the form to its initial state.
         document.getElementById("parameters-form").reset();
         // Update all slider displays.
         document.querySelectorAll("input[type='range']").forEach((slider) => {
             updateValue(slider.name, slider.value);
         });
     }
     // Function to fetch current parameters from the server and update the form inputs.
     function fetchParameters() {
         fetch("/get_parameters")
             .then((response) => response.json())
             .then((data) => {
                 document.getElementById("delta-value").textContent = data.delta;
                 document.querySelector("input[name='delta']").value = data.delta;

                 document.getElementById("Kp_t-value").textContent = data.Kp_t;
                 document.querySelector("input[name='Kp_t']").value = data.Kp_t;

                 document.getElementById("Ki_t-value").textContent = data.Ki_t;
                 document.querySelector("input[name='Ki_t']").value = data.Ki_t;

                 document.getElementById("Kd_t-value").textContent = data.Kd_t;
                 document.querySelector("input[name='Kd_t']").value = data.Kd_t;

                 document.getElementById("Kp_s-value").textContent = data.Kp_s;
                 document.querySelector("input[name='Kp_s']").value = data.Kp_s;

                 document.getElementById("Ki_s-value").textContent = data.Ki_s;
                 document.querySelector("input[name='Ki_s']").value = data.Ki_s;

                 document.getElementById("Kd_s-value").textContent = data.Kd_s;
                 document.querySelector("input[name='Kd_s']").value = data.Kd_s;

                 document.getElementById("maxMoveThrottle-value").textContent = data.maxMoveThrottle;
                 document.querySelector("input[name='maxMoveThrottle']").value = data.maxMoveThrottle;

                 // For the min sliders, display the negative value but set the slider to the absolute value.
                 document.getElementById("minMoveThrottle-value").textContent = data.minMoveThrottle;
                 document.querySelector("input[name='minMoveThrottle']").value = Math.abs(data.minMoveThrottle);

                 document.getElementById("maxMoveSteering-value").textContent = data.maxMoveSteering;
                 document.querySelector("input[name='maxMoveSteering']").value = data.maxMoveSteering;

                 document.getElementById("minMoveSteering-value").textContent = data.minMoveSteering;
                 document.querySelector("input[name='minMoveSteering']").value = Math.abs(data.minMoveSteering);
             })
             .catch((err) => {
                 console.error("Error fetching parameters:", err);
             });
     }
     // When the page loads, fetch the current parameter values.
     window.onload = function () {
         fetchParameters();
     };
     // Form submission to update parameters on the ESP32.
     document.getElementById("parameters-form").onsubmit = async (e) => {
         e.preventDefault();
         let formData = new FormData(e.target);
         // For the min sliders, convert the positive value to negative before sending.
         if (formData.has("minMoveThrottle")) {
             let val = Number(formData.get("minMoveThrottle"));
             formData.set("minMoveThrottle", -val);
         }
         if (formData.has("minMoveSteering")) {
             let val = Number(formData.get("minMoveSteering"));
             formData.set("minMoveSteering", -val);
         }
         fetch("/update_parameters", { method: "POST", body: formData })
             .then((response) => response.text())
             .then((data) => {
                 document.getElementById("status").textContent = "Parameters updated successfully";
                 // Optionally, re-fetch parameters to update the UI.
                 fetchParameters();
             })
             .catch((err) => {
                 console.error("Error updating parameters:", err);
             });
     };
    </script>
  </body>
</html>
